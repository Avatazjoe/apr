{% extends "base.html" %}
{% load i18n %}
{% load crispy_forms_tags %}
{% load staticfiles %}
{% block extracss %}
	<link rel="stylesheet" href="{% static 'css/datepicker3.css' %}" type="text/css" />
	<link rel="stylesheet" href="{% static 'jquery-ui/jquery-ui.min.css' %}" media="all" type="text/css" />
	<link rel="stylesheet" href="{% static 'jquery-week-calendar/css/jquery.weekcalendar.css' %}" media="all" type="text/css" />
	<link rel="stylesheet" type="text/css" media="all" href="{% static 'css/week-calendar.css' %}" />
	<link rel="stylesheet" href="{% static 'intlTelInput/css/intlTelInput.css' %}" type="text/css" />
	<link rel="stylesheet" href="{% static 'jquery.growl/css/jquery.growl.css' %}" type="text/css" />
{% endblock %}
{% block title %}{{CUSTOMER.name|default_if_none:"AppointWare"}}{% endblock %}
{% block top_sidebar %}<div id="datepicker"></div>{% endblock %}
{% block main_content %}

	<div class="panel panel-default">
	  <div class="panel-heading clearfix">
	    <h3 class="panel-title pull-left">
	    {% block calendar_title %}{{CUSTOMER.name|default_if_none:"AppointWare"}}{% endblock %}
	    </h3>
	    <div class="btn-group pull-right">
            <a href="#" class="btn btn-primary" id="choose-date">{% trans "Go To Date" %}</a>
	    </div>
	  </div>
	  <div class="panel-body">
	    <div id="calendar" class="row"></div>	    
	  </div>
	</div>	

	<!-- Modal -->
	<div class="modal fade" id="add-appointment-modal" tabindex="-1" role="dialog" aria-labelledby="add-appointment-modalLabel" aria-hidden="true">
	  <div class="modal-dialog">
	    <div class="modal-content">
	      <div class="modal-header">
	        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
	        <h4 class="modal-title" id="add-appointment-modalLabel">{% trans "Add New Appointment" %}</h4>
	      </div>
	      <div class="modal-body">
	      	<div id="add-appointment-form" style="display:none;">{% crispy AppointmentForm AppointmentFormHelper %}</div>
	        <div id="select-client">	
	        	{% crispy SelectClientForm %}
	        	<a href="javascript:void(0)" class="client-toggler btn btn-default" >{% trans "Or Add New Client" %}</a>
	        </div>
	        <div id="add-client" style="display:none;">	        	
	        	{% crispy AddClientForm %}
	        	<a href="javascript:void(0)" class="client-toggler btn btn-default" >{% trans "Or Select Existing Client" %}</a>
	        </div>
	      </div>
	      <div class="modal-footer">
	        <button type="button" id="modal-close" class="btn btn-default" data-dismiss="modal">{% trans "Cancel" %}</button>
	      </div>
	    </div>
	  </div>
	</div>

{% endblock %}
{% block extrajs %}
	<script src="{% static 'js/jquery.cookie.js' %}"></script>
	<script src="{% static 'jquery-ui/jquery-ui.min.js' %}"></script>
	<script src="{% static 'js/jquery-migrate-1.2.1.js' %}"></script>
	<script src="{% static 'jquery-week-calendar/js/jquery.weekcalendar.js' %}"></script>
	<script src="{% static 'js/bootstrap-datepicker.js' %}"></script>
	<script src="{% static 'intlTelInput/js/intlTelInput.min.js' %}"></script>
	<script src="{% static 'jquery.growl/js/jquery.growl.js' %}"></script>	
	
	{% block event_feed_js %}
	 	<script type='text/javascript'>
	 		//id-add-client-form
	 		$(document).on('submit','#id-add-client-form',function(event){
	 			event.preventDefault();
	 			var add_client_form = '#id-add-client-form';
	 			$.ajax({
	 				url: "{% url 'appointments:process_add_client_form' %}",
	 				type: "POST",
	 				data: $(add_client_form).serialize(),
	 				dataType: 'json',
	 				success: function(data) {				    	
	 					if (!(data['success'])) {
	 						$(add_client_form).replaceWith(data['form_html']);
	 					}
	 					else {
	 						document.getElementById('appointment-client-id').value = data['client_id'];
	 						$('#id-hidden-add-appointment-form').submit();
	 					}
	 				},
	 				error: function () {
	 					$(add_client_form).find('.error-message').show()
	 				}
	 			});
	 		});

	 		//select-user-form
	 		$(document).on('submit','#id-select-client-form',function(event){
	 			event.preventDefault();
	 			var select_client_form = '#id-select-client-form';
	 			$.ajax({
	 				url: "{% url 'appointments:process_select_client_form' %}",
	 				type: "POST",
	 				data: $(select_client_form).serialize(),
	 				dataType: 'json',
	 				success: function(data) {				    	
	 					if (!(data['success'])) {
	 						$(select_client_form).replaceWith(data['form_html']);
	 					}
	 					else {
	 						document.getElementById('appointment-client-id').value = data['client_id'];
	 						$('#id-hidden-add-appointment-form').submit();
	 					}
	 				},
	 				error: function () {
	 					$(select_client_form).find('.error-message').show()
	 				}
	 			});
	 		});

	 		//select-user-form
	 		$(document).on('submit','#id-hidden-add-appointment-form',function(event){
	 			event.preventDefault();
	 			var appointment_form = '#id-hidden-add-appointment-form';
	 			$.ajax({
	 				url: "{% url 'appointments:add_event' %}",
	 				type: "POST",
	 				data: $(appointment_form).serialize(),
	 				dataType: 'json',
	 				success: function(data) {				    	
	 					if (data) {
	 						console.log(data);
	 						$('#add-appointment-modal').modal('hide');
	 						$.growl.notice({ 
	 							location: 'br',
	 							title: "Added Appointment", 
	 							message: 'Start: ' + document.getElementById('appointment-start-id').value + '<br/>End: ' + document.getElementById('appointment-end-id').value 
	 						});
	 					} else {
	 						console.log(data);
	 					}
	 				},
	 				error: function () {
	 					console.log("Error creating appointment");
	 				}
	 			});
	 		});

	 		$(document).ready(function() {
	 			$('#calendar').weekCalendar({
	 				timeslotsPerHour: 4,
	 				timeslotHeight: 20,
	 				defaultEventLength: 4,
	 				// displayFreeBusys: true,
	 				// defaultFreeBusy: {free: true},
	 				readonly : false,
	 				daysToShow: 5,
	 				businessHours: {
 					{% if CUSTOMER.global_opening_time.from_hour.hour %}
 						start: {{CUSTOMER.global_opening_time.from_hour.hour}},
 					{% else %}
 						start: 8,
 					{% endif %}
 					{% if CUSTOMER.global_opening_time.from_hour.hour %}
 	                	end: {{CUSTOMER.global_closing_time.to_hour.hour}},
 	                {% else %}
 	                	end: 17,
 	                {% endif %}
 	                limitDisplay: true
                	},
                	height: function($calendar) {
                 	return $(window).height() - $('h1').outerHeight(true);
                	},
                	minBodyHeight: 1200,   
                	users: [
 					{% for venue in venues %}
 						{
 							'id': {{venue.id}},
 							'name': '{{venue.name|upper}}'
 						},
 					{% endfor %}
	 				],		
                	showAsSeparateUser: true,	
                	data: "{% url 'appointments:calendar_event_feed' %}",
                	getUserId: function(user, index, calendar) {
 				    return user.id;
	 				},
	 				getUserName: function(user, index, calendar) {
	 				    return user.name;
	 				},
	 				eventRender: function(calEvent, $event) {
 				        if (calEvent.end.getTime() < new Date().getTime()) {
 				          	$event.css('backgroundColor', '#aaa');
 				          	$event.find('.time').css({
 				            	backgroundColor: '#999',
 				            	border:'1px solid #888'
 				          	});
 				        }
 				    },
	 				eventNew: function(calEvent, $event) {
 				        document.getElementById('appointment-start-id').value = calEvent.start.toString();
 				        document.getElementById('appointment-end-id').value = calEvent.end.toString();
 				        document.getElementById('appointment-venue-id').value = calEvent.userId;
 				        $('#add-appointment-modal').modal();
	 				},
	 				eventDrop: function(calEvent, $event) {
	 					editEvent(calEvent);
	 				    $.growl.notice({ 
	 				    	location: 'br',
	 				    	title: "Changed Appointment", 
	 				    	message: 'Start: ' + calEvent.start + '<br/>End: ' + calEvent.end 
	 				    });
	 				},
	 				eventResize: function(calEvent, $event) {
	 					editEvent(calEvent);
	 				    $.growl.notice({ 
	 				    	location: 'br',
	 				    	title: "Changed Appointment", 
	 				    	message: 'Start: ' + calEvent.start + '<br/>End: ' + calEvent.end 
	 				    });
	 				},
	 				eventClick: function(calEvent, $event) {	 				        
	 				    $.growl.notice({ 
	 				    	location: 'br',
	 				    	title: "Clicked Appointment", 
	 				    	message: 'Start: ' + calEvent.start + '<br/>End: ' + calEvent.end 
	 				    });
	 				},
	 				noEvents: function() {
	 				    $.growl.notice({ 
	 				    	location: 'br',
	 				    	message: 'There are no appointments to show!'
	 				    });
	 				}
	 			});

				$('#choose-date').datepicker()
					.on('changeDate', function(ev){
						var dn = new Date(ev.date);
						$('#calendar').weekCalendar("gotoWeek", dn);
					});

				function editEvent(calEvent) {
					var csrftoken = $.cookie('csrftoken');
					$.post("{% url 'appointments:edit_event' %}", {
					        csrfmiddlewaretoken: csrftoken,
					        id: calEvent.id,
					        client: calEvent.clientId,
					        start_datetime: calEvent.start, 
					        end_datetime: calEvent.end, 
					        venue: calEvent.userId,
					    },
					    function(data) {
					        console.log(data);
					    }
					);
				}

				$('body').on("click touchstart", ".client-toggler", function(e){
				   $("#select-client, #add-client").toggle();
				});

				$('#add-appointment-modal').on('shown.bs.modal', function() {
					//Make sure the modal and backdrop are siblings (changes the DOM)
					$(this).before($('.modal-backdrop'));
					//Make sure the z-index is higher than the backdrop
					$(this).css("z-index", parseInt($('.modal-backdrop').css('z-index')) + 1);
				});

				$('#add-appointment-modal').on('hide.bs.modal', function (e) {
				  	$('#calendar').weekCalendar('refresh');
				})

				$("#id_phone").intlTelInput({
					autoFormat: true,
					nationalMode: false,
				  	preferredCountries: ['ke'],
				  	utilsScript: "{% static 'intlTelInput/lib/libphonenumber/build/utils.js' %}"
				});
	 		});

			$(document).ajaxStop(function() {
				$("#id_phone").intlTelInput({
					autoFormat: true,
					nationalMode: false,
				  	preferredCountries: ['ke'],
				  	utilsScript: "{% static 'intlTelInput/lib/libphonenumber/build/utils.js' %}"
				});
			});

			// on blur: validate
			var telInput = $("#id_phone");
			telInput.blur(function() {
			  if ($.trim(telInput.val())) {
			    if (telInput.intlTelInput("isValidNumber")) {		      
			      $('#div_id_phone').addClass('has-success');
			      $("#id_full_phone").val($("#id_phone").intlTelInput("getNumber"));
			    } else {
			      telInput.addClass("error");
			      $('#div_id_phone').addClass('has-error');
			    }
			  }
			});

			// on keydown: reset
			telInput.keydown(function() {
			  $('#div_id_phone').removeClass('has-error');
			});	

			function updateCalendarPeriodically() {
				$('#calendar').weekCalendar('refresh');
			}

			var interval = setInterval(updateCalendarPeriodically, 300000);
	 	</script>		
	{% endblock %}
{% endblock %}