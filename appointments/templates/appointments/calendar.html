{% extends "base.html" %}
{% load i18n %}
{% load crispy_forms_tags %}
{% load staticfiles %}
{% block extracss %}
	<link rel="stylesheet" href="{% static 'css/datepicker3.css' %}" type="text/css" />
	<link rel="stylesheet" href="{% static 'jquery-ui/jquery-ui.min.css' %}" media="all" type="text/css" />
	<link rel="stylesheet" href="{% static 'jquery-week-calendar/css/jquery.weekcalendar.css' %}" media="all" type="text/css" />
	<link rel="stylesheet" type="text/css" media="all" href="{% static 'css/week-calendar.css' %}" />
{% endblock %}
{% block title %}{{CUSTOMER.name|default_if_none:"AppointWare"}}{% endblock %}
{% block top_sidebar %}<div id="datepicker"></div>{% endblock %}
{% block main_content %}

	<div class="panel panel-default">
	  <div class="panel-heading clearfix">
	    <h3 class="panel-title pull-left">
	    {% block calendar_title %}{{CUSTOMER.name|default_if_none:"AppointWare"}}{% endblock %}
	    </h3>
	    <div class="btn-group pull-right">
            <a href="#" class="btn btn-primary" id="choose-date">{% trans "Go To Date" %}</a>
	    </div>
	  </div>
	  <div class="panel-body">
	  	<div id="wowow" class="row"></div>
	    <div id="calendar" class="row"></div>
	  </div>
	</div>	

{% endblock %}
{% block extrajs %}
	<script src="{% static 'js/jquery.cookie.js' %}"></script>
	<script src="{% static 'jquery-ui/jquery-ui.min.js' %}"></script>
	<script src="{% static 'js/jquery-migrate-1.2.1.js' %}"></script>
	<script src="{% static 'jquery-week-calendar/js/jquery.weekcalendar.js' %}"></script>
	<script src="{% static 'js/bootstrap-datepicker.js' %}"></script>
	
	{% block event_feed_js %}
	 	<script type='text/javascript'>
	 		$(document).ready(function() {
	 			$('#calendar').weekCalendar({
	 				timeslotsPerHour: 2,
	 				timeslotHeight: 20,
	 				defaultEventLength: 2,
	 				// displayFreeBusys: true,
	 				// defaultFreeBusy: {free: true},
	 				readonly : false,
	 				daysToShow: 5,
	 				businessHours: {
 					{% if CUSTOMER.global_opening_time.from_hour.hour %}
 						start: {{CUSTOMER.global_opening_time.from_hour.hour}},
 					{% else %}
 						start: 8,
 					{% endif %}
 					{% if CUSTOMER.global_opening_time.from_hour.hour %}
 	                	end: {{CUSTOMER.global_closing_time.to_hour.hour}},
 	                {% else %}
 	                	end: 17,
 	                {% endif %}
 	                limitDisplay: true
                	},
                	height: function($calendar) {
                 	return $(window).height() - $('h1').outerHeight(true);
                	},
                	minBodyHeight: 1080,   
                	users: [
 					{% for venue in venues %}
 						{
 							'id': {{venue.id}},
 							'name': '{{venue.name|upper}}'
 						},
 					{% endfor %}
	 				],		
                	showAsSeparateUser: true,	
                	data: "{% url 'appointments:calendar_event_feed' %}",
                	getUserId: function(user, index, calendar) {
 				    return user.id;
	 				},
	 				getUserName: function(user, index, calendar) {
	 				    return user.name;
	 				},
	 				eventNew: function(calEvent, $event) {
 				        displayMessage('<strong>Added event</strong><br/>Start: ' + calEvent.start + '<br/>End: ' + calEvent.end);
 				        alert('You\'ve added a new event. You would capture this event, add the logic for creating a new event with your own fields, data and whatever backend persistence you require.');
	 				},
	 				eventDrop: function(calEvent, $event) {
	 					editEvent(calEvent);
	 				    displayMessage('<strong>Moved Event</strong><br/>Start: ' + calEvent.start + '<br/>End: ' + calEvent.end);
	 				},
	 				eventResize: function(calEvent, $event) {
	 					editEvent(calEvent);
	 				    displayMessage('<strong>Resized Event</strong><br/>Start: ' + calEvent.start + '<br/>End: ' + calEvent.end);
	 				},
	 				noEvents: function() {
	 				    displayMessage('There are no events for this week');
	 				}
	 			});

				$('#choose-date').datepicker()
					.on('changeDate', function(ev){
						var dn = new Date(ev.date);
						$('#calendar').weekCalendar("gotoWeek", dn);
					});
				function displayMessage(message) {
				    $('#wowow').html(message).fadeIn();
				}

				function editEvent(calEvent) {
					var csrftoken = $.cookie('csrftoken');
					$.post("{% url 'appointments:edit_event' %}", {
					        csrfmiddlewaretoken: csrftoken,
					        id: calEvent.id,
					        client: calEvent.clientId,
					        start_datetime: calEvent.start, 
					        end_datetime: calEvent.end, 
					        venue: calEvent.userId,
					    },
					    function(data) {
					        console.log(data);
					    }
					);
				}
	 		});
	 	</script>		
	{% endblock %}
{% endblock %}